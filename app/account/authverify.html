<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0">
		<link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.2/css/bootstrap.min.css"/>
		<link href="https://cdn.bootcdn.net/ajax/libs/bootstrap-icons/1.10.2/font/bootstrap-icons.css" rel="stylesheet">
		<link href="https://cdn.bootcdn.net/ajax/libs/jquery-confirm/3.3.4/jquery-confirm.min.css" rel="stylesheet">
		<title>安全验证</title>
		<style>input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none}*:focus{outline: 0;}</style>
	</head>
	<body>
		<div id="preloader" style="position:fixed;width:100%;height:100vh;background-color:#fbfbfb;z-index:99999;">
			<div style="display:block;text-align:center;margin-top:40vh;">
				<div class="spinner-border ml-auto" aria-hidden="true"></div>
			</div>
			<div style="font-size:.8rem;margin-top:40vh;text-align:center">
				<p class="text-secondary">&copy;Copyright SF工具箱 All.right.<br>长时间无反应?返回后再试试</p>
			</div>
		</div>
		<div class="p-4" id="step1">
		    <h3 class="mt-4"><b>新设备登录验证</b></h3>
			<p style="font-size: .8rem;">您正在一台新设备上登录您的账号，请完成验证</p>
			<div class="card border border-0 border-top border-5 border-primary shadow rounded" style="display:none;" id="mobile">
			    <div class="card-body d-flex align-items-center">
					<div><svg width="2.4rem" height="2.4rem" fill="none" viewBox="0 0 48 48"><rect x="11" y="4" width="26" height="40" rx="3" fill="none" stroke="#000" stroke-width="3"/><path d="M22 10L26 10" stroke="#000" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/><path d="M20 38H28" stroke="#000" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
					<div class="ms-2"><p class="m-0">密保手机验证</p><span class="text-secondary" style="font-size: .8rem;">密保手机接收短信或电话验证</span></div>
			    </div>
			</div>
			<div class="mt-4 card border border-0 border-top border-5 border-primary shadow rounded" style="display:none;" id="realname">
			    <div class="card-body d-flex align-items-center">
					<div><svg width="2.4rem" height="2.4rem" fill="none" viewBox="0 0 48 48"><path d="M4 34V44H14" stroke="#000" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/><path d="M34 44H44V34" stroke="#000" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/><path d="M34 4H44V14" stroke="#000" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/><path d="M14 4H4V14" stroke="#000" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/><path d="M16 34C16 34 19 37 24 37C29 37 32 34 32 34" stroke="#000" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/><path d="M24 14V23C24 25 22 27 20 27H19" stroke="#000" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/><path d="M34 14V16" stroke="#000" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/><path d="M14 14V16" stroke="#000" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
					<div class="ms-2"><p class="m-0">人脸识别验证</p><span class="text-secondary" style="font-size: .8rem;">通过预留的实名信息进行人脸识别验证</span></div>
			    </div>
			</div>
			<div class="mt-4 card border border-0 border-top border-5 border-primary shadow rounded" style="display:none;" id="qrcode">
			    <div class="card-body d-flex align-items-center">
					<div><svg width="2.4rem" height="2.4rem" viewBox="0 0 48 48" fill="none"><path d="M20 6H6V20H20V6Z" fill="none" stroke="#000" stroke-width="3" stroke-linejoin="round"/><path d="M20 28H6V42H20V28Z" fill="none" stroke="#000" stroke-width="3" stroke-linejoin="round"/><path d="M42 6H28V20H42V6Z" fill="none" stroke="#000" stroke-width="3" stroke-linejoin="round"/><path d="M29 28V42" stroke="#000" stroke-width="3" stroke-linecap="round"/><path d="M41 28V42" stroke="#000" stroke-width="3" stroke-linecap="round"/></svg></div>
					<div class="ms-2"><p class="m-0">旧设备扫码验证</p><span class="text-secondary" style="font-size: .8rem;">使用已经登录该账号的设备进行验证</span></div>
			    </div>
			</div>
			<div class="mt-4 text-center">以上方式都无法使用？请联系<a href="//sftools.link/app/system/group.html">人工客服</a></div>
		</div>

		<div class="p-4" id="mobile_page" style="display: none;">
		    <h3 class="mt-4"><b>密保手机验证</b></h3>
			<p style="font-size: .8rem;">请输入该账号的密保手机号</p>
			<div class="mt-4 border-bottom pb-1 px-2">
				<span>密保手机号</span>
				<div class="d-flex col-12">
					<input class="border-0 col-8" type="number" id="mobile_input" placeholder="账户绑定的密保手机号"/>
					<a id="getcode">获取验证码</a>
				</div>
			</div>
			<div class="mt-4 border-bottom pb-1 px-2">
				<span>验证码</span>
				<input class="border-0 col-12" type="number" id="code" placeholder="请输入收到的验证码"/>
			</div>
			<button class="col-12 mt-4 btn btn-outline-primary rounded-pill">返回</button>
		    <button class="col-12 mt-2 btn btn-primary rounded-pill">完成</button>
		</div>

		<div class="p-4" id="realname_page"  style="display: none;">
		    <h3 class="mt-4"><b>人脸识别验证</b></h3>
			<p style="font-size: .8rem;">请您阅读以下注意事项</p>
			<div class="mb-4 d-flex align-items-center">
				<div class="btn d-block btn-outline-primary rounded-circle px-3 py-2">1</div>
				<p class="m-0 ms-3">请在光线良好、无遮挡物的情况下进行识别</p>
			</div>
			<div class="my-4 d-flex align-items-center">
				<div class="btn d-block btn-outline-primary rounded-circle px-3 py-2">2</div>
				<p class="m-0 ms-3">请摘下眼睛，口罩以及会遮挡面部的物品</p>
			</div>
			<div class="my-4 d-flex align-items-center">
				<div class="btn d-block btn-outline-primary rounded-circle px-3 py-2">3</div>
				<p class="m-0 ms-3">该功能仅供账户实际实名人使用</p>
			</div>
			<div class="alert alert-primary p-2">您的人脸信息将会按照《隐私政策》的约定进行储存</div>
			<button class="col-12 mt-4 btn btn-primary rounded-pill">开始验证</button>
			<button class="col-12 mt-2 btn btn-outline-primary rounded-pill">返回</button>
		</div>

		<div class="p-4" id="qrcode_page" style="display: none;">
		    <h3 class="mt-4"><b>设备扫码验证</b></h3>
			<p style="font-size: .8rem;">请您按照以下步骤操作</p>
			<div class="text-center">
				<img style="width: 220px;height: 220px;" id="qrcode_img" src="data:image;base64,R0lGODlhBAAEAIAAAMzMzAAAACH5BAAAAAAALAAAAAAEAAQAAAIEhI8JBQA7" />
			</div>
			<div class="my-4 d-flex align-items-center">
				<div class="btn d-block btn-outline-primary rounded-circle px-3 py-2">1</div>
				<p class="m-0 ms-3">使用旧设备打开软件</p>
			</div>
			<div class="my-4 d-flex align-items-center">
				<div class="btn d-block btn-outline-primary rounded-circle px-3 py-2">2</div>
				<p class="m-0 ms-3">点击首页右上角的"扫码"按钮</p>
			</div>
			<div class="my-4 d-flex align-items-center">
				<div class="btn d-block btn-outline-primary rounded-circle px-3 py-2">3</div>
				<p class="m-0 ms-3">扫描上方的二维码完成验证</p>
			</div>
			<button class="col-12 mt-4 btn btn-outline-primary rounded-pill">返回</button>
		</div>

        <div class="p-4" id="finish" style="display: none;">
            <div class="text-center" style="margin-top:20vh">
                <h2><b>验证成功</b></h2>
		        <p class="text-secondary">您已通过设备验证，现在请退出本页面继续完成登录</p>
            </div>
		</div>

	    <script type="text/javascript" src="https://lf3-cdn-tos.bytecdntp.com/cdn/expire-1-M/jquery/3.6.0/jquery.min.js"></script>
	    <script src="https://cdn.bootcdn.net/ajax/libs/jquery-confirm/3.3.4/jquery-confirm.min.js"></script>
		<script type="text/javascript" src="../../uni.webview.js"></script>
	    <script>
			document.onreadystatechange = function(){
				if(document.readyState == 'complete'){
					document.getElementById("preloader").style.display="none";
				}
			}
			const env=decodeURIComponent(getenv())
			window.sftools.init(()=>{
				let user=getvalue('user');
				let loading=$.alert({title:'',content:'<div class="p-2 d-flex align-items-center justify-content-between"> <strong>操作正在处理</strong> <div class="spinner-border ml-auto" role="status" aria-hidden="true"></div></div>',buttons:[],closeIcon:false});
				window.sftools.request({
					url:"Account/AuthVerify",
					data:{"type":'getways',"user":user,"env":env},
					success:function(data){
					    for(var n=0;n<data.data.length;n++){
							$('#'+data.data[n]).show()
						}
						loading.close();
					},fail:i=>{
					    loading.close();
						if(i && i!=="已完成行为验证" && i!==""){
							$.alert({title:'错误',type:'red',content:i,buttons:[],closeIcon:false}); 
						}
					}
				});
			})
			$('#getcode').click(_=>{
				let user=getvalue('user');
			    let mobile=$('#mobile_input').val();
				if(mobile.length!==11){
					$.alert({title:'错误',type:'red',content:'手机号格式有误'}); 
					return;
				}
			    let loading=$.alert({title:'',content:'<div class="p-2 d-flex align-items-center justify-content-between"> <strong>操作正在处理</strong> <div class="spinner-border ml-auto" role="status" aria-hidden="true"></div></div>',buttons:[],closeIcon:false});
				window.sftools.request({
					url:"Account/AuthVerify",
					data:{"type":'sendcode',"user":user,"mobile":mobile,"env":env},
					success:function(data){
					    $.alert({title:'',content:'验证码已发送'}); 
						loading.close();
					},fail:i=>{
        			    loading.close();
						if(i && i!=="已完成行为验证" && i!==""){
							$.alert({title:'错误',type:'red',content:i}); 
						}else if(i=="已完成行为验证"){
							$('#getcode').click()
						}
        			}
				});
			});
			$('#mobile_page .btn-primary').click(_=>{
				let user=getvalue('user');
			    let mobile=$('#mobile_input').val();
				let code=$('#code').val();
				if(user.length<1){
					$.alert({title:'错误',type:'red',content:'账号或手机号不能留空'}); 
					return;
				}
				if(mobile.length!==11){
					$.alert({title:'错误',type:'red',content:'手机号格式有误'}); 
					return;
				}
				if(code.length<1){
					$.alert({title:'错误',type:'red',content:'验证码不能留空'}); 
					return;
				}
			    let loading=$.alert({title:'',content:'<div class="p-2 d-flex align-items-center justify-content-between"> <strong>操作正在处理</strong> <div class="spinner-border ml-auto" role="status" aria-hidden="true"></div></div>',buttons:[],closeIcon:false});
				window.sftools.request({
					url:"Account/AuthVerify",
					data:{"type":'usecode',"user":user,"mobile":mobile,"code":code,"env":env},
					success:function(data){
					    $('#mobile_page').hide();
						$('#finish').show();
						loading.close();
					},fail:i=>{
        			    loading.close();
        				if(i && i!=="已完成行为验证" && i!==""){
        					$.alert({title:'错误',type:'red',content:i}); 
        				}else if(i=="已完成行为验证"){
							$('#mobile_page .btn-primary').click()
						}
        			}
				});
			});
			$('#mobile_page .btn-outline-primary').click(_=>{
			    $('#mobile_page').hide();
			    $('#step1').show();
			});
			$('#mobile').click(_=>{
			    $('#step1').hide();
			    $('#mobile_page').show();
			});
			$('#realname').click(_=>{
			    $('#step1').hide();
			    $('#realname_page').show();
			});
			$('#realname_page .btn-outline-primary').click(_=>{
			    $('#realname_page').hide();
			    $('#step1').show();
			});
			$('#realname_page .btn-primary').click(_=>{
				let user=getvalue('user');
			    let loading=$.alert({title:'',content:'<div class="p-2 d-flex align-items-center justify-content-between"> <strong>操作正在处理</strong> <div class="spinner-border ml-auto" role="status" aria-hidden="true"></div></div>',buttons:[],closeIcon:false});
				window.sftools.request({
					url:"Account/AuthVerify",
					data:{"type":'face_reg',"user":user,"env":env},
					success:function(data){
						loading.close();
						window.sftools.run({type:'face_auth',data:{id:data.data}},e=>{
							let loading=$.alert({title:'',content:'<div class="p-2 d-flex align-items-center justify-content-between"> <strong>联网比对中</strong> <div class="spinner-border ml-auto" role="status" aria-hidden="true"></div></div>',buttons:[],closeIcon:false});
							window.sftools.request({
								url:"Account/AuthVerify",
								data:{"type":'face_use',"user":user,"faceid":e,"env":env},
								success:function (data) {
									$('#realname_page').hide();
									$('#finish').show();
									loading.close();
								},fail:i=>{
									loading.close();
									if(i && i!=="已完成行为验证" && i!==""){
										$.alert({title:'错误',type:'red',content:i}); 
									}else if(i=="已完成行为验证"){
										$('#realname_page .btn-primary').click()
									}
								}
							});
						},e=>{
							$.alert({title:'错误',type:'red',content:e}); 
						});
					},fail:i=>{
        			    loading.close();
        				if(i && i!=="已完成行为验证" && i!==""){
        					$.alert({title:'错误',type:'red',content:i}); 
        				}else if(i=="已完成行为验证"){
							$('#realname_page .btn-primary').click()
						}
        			}
				});
			});
			$('#qrcode_page .btn-outline-primary').click(_=>{
			    $('#qrcode_page').hide();
			    $('#step1').show();
			});
			$('#qrcode').click(_=>{
			    let user=getvalue('user');
			    let loading=$.alert({title:'',content:'<div class="p-2 d-flex align-items-center justify-content-between"> <strong>操作正在处理</strong> <div class="spinner-border ml-auto" role="status" aria-hidden="true"></div></div>',buttons:[],closeIcon:false});
				window.sftools.request({
					url:"Account/AuthVerify",
					data:{"type":'qrcode',"user":user,"env":env},
					success:function(data){
						loading.close();
					    $('#qrcode_img').attr('src','https://api.pwmqr.com/qrcode/create/?url='+data.data)
						$('#step1').hide();
						$('#qrcode_page').show();
					},fail:i=>{
						loading.close();
        				if(i && i!=="已完成行为验证" && i!==""){
        					$.alert({title:'错误',type:'red',content:i}); 
        				}else if(i=="已完成行为验证"){
							$('#qrcode').click()
						}
        			}
				});
			});
			function getvalue(variable) {
				var query = window.location.search.substring(1);
				var vars = query.split("&");
			    for (var i = 0; i < vars.length; i++) {
			        var pair = vars[i].split("=");
			        if (pair[0] == variable) {
			            return pair[1]
			        }
			    }
			    return (false)
			}
			function getenv(){
				var query = window.location.search.substring(1);
				var vars = query.split("env=");
				return vars[1]
			}
	    </script>
	</body>
</html>
