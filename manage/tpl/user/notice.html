<!DOCTYPE html>
<html lang="zh">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimal-ui">
		<title>消息弹窗 - SF工具箱</title>
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-touch-fullscreen" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="default">
		<link href="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/css/bootstrap.min.css" rel="stylesheet">
		<link href="https://cdn.bootcdn.net/ajax/libs/jquery-confirm/3.3.4/jquery-confirm.min.css" rel="stylesheet">
		<link rel="stylesheet" type="text/css" href="../../css/materialdesignicons.min.css">
		<link rel="stylesheet" type="text/css" href="../../css/style.min.css">
		<style>p{margin:0;}input::-webkit-outer-spin-button,input::-webkit-inner-spin-button {-webkit-appearance: none;}</style>
	</head>
  
	<body>
		<div class="container-fluid p-t-15">
			<div class="row">
				<div class="col-lg-12">
					<div class="card">
					    <div class="card-body">
					        <div class="row">
					        	<div class="col-md-4">
					        		<div class="row">
					        			<label class="col-sm-4 col-form-label">
					        				<span class="text-danger">*</span>用户ID
					        			</label>
					        			<div class="col-sm-8">
					        				<input type="text" class="form-control pull-left" name="user" value=""
					        				placeholder="用户ID">
					        			</div>
					        		</div>
					        	</div>
					        	<div class="col-md-4">
					        		<button class="btn btn-primary me-1">搜索</button>
									<button class="btn btn-success me-1">添加</button>
					        	</div>
					        </div>
					        <div class="mt-2 table-responsive">
					            <table class="table table-bordered">
									<thead>
										<tr>
											<th>ID</th>
											<th>用户</th>
											<th>应用</th>
											<th>类型</th>
											<th>标题</th>
											<th>内容</th>
											<th>状态</th>
											<th>操作</th>
										</tr>
									</thead>
									<tbody></tbody>
					            </table>
					        </div>
							<ul class="pagination align-items-center">
							    <li class="page-item disabled" name="上一页"><a class="page-link">上一页</a></li>
								<div class="me-2 text-center" style="width:3rem;">
									<input class="form-control text-center" name="page" type="number" />
								</div>
							    <li class="page-item disabled" name="下一页"><a class="page-link" href="#">下一页</a></li>
								<li name="page">共 0 页</li>
							</ul>
					    </div>
					</div>
				</div>
			</div>
			<div class="modal fade" id="detail">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h6 class="modal-title" id="exampleModalLiveLabel">弹窗详情</h6>
							<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
						</div>
					  <div class="modal-body">
					  </div>
					</div>
				</div>
			</div>
			<div class="modal fade" id="add">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h6 class="modal-title" id="exampleModalLiveLabel">添加通知</h6>
							<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
						</div>
					  <div class="modal-body">
						  <div class="mb-3">
						  	<label class="form-label">用户ID</label>
						  	<input class="form-control"id="user"/>
						  </div>
						  <div class="mb-3">
						  	<label class="form-label">通知类型</label>
						  	<select class="form-select" id="type">
						  		<option>弹窗</option>
						  		<option>通知栏</option>
								<option>直接跳转</option>
						  	</select>
						  </div>
						  <div class="mb-3" id="push-type" style="display:none;">
						  	<label class="form-label">通知栏点击反馈</label>
						  	<select class="form-select">
						  		<option>弹窗</option>
						  		<option>Url</option>
								<option>无</option>
						  	</select>
						  </div>
						  <div class="mb-3" id="title">
						  	<label class="form-label">标题</label>
						  	<input class="form-control"/>
						  </div>
						  <div class="mb-3" id="body">
						  	<label class="form-label">内容</label>
						  	<input class="form-control"/>
						  </div>
						  <div class="mb-3" id="push-title" style="display:none;">
						  	<label class="form-label">通知栏标题</label>
						  	<input class="form-control"/>
						  </div>
						  <div class="mb-3" id="push-detail" style="display:none;">
						  	<label class="form-label">通知栏内容</label>
						  	<input class="form-control"/>
						  </div>
						  <div class="mb-3" id="push-body" style="display:none;">
						  	<label class="form-label">跳转参数</label>
						  	<input class="form-control"/>
						  </div>
						  <div class="mb-3" id="push-body-type" style="display:none;">
						  	<label class="form-label">跳转效果</label>
						  	<select class="form-select">
						  		<option>无</option>
						  		<option>增页跳转</option>
						  		<option>替换跳转</option>
						  		<option>重载跳转</option>
						  	</select>
						  </div>
						  <div class="mb-3" id="alert-type">
						      <div class="form-check">
						          <input type="checkbox" class="form-check-input"/>
						          <label class="form-check-label not-user-select">双按钮</label>
						      </div>
						  </div>
						  <div class="mb-3" id="confirm-title">
						  	<label class="form-label">确认按钮文字</label>
						  	<input class="form-control"/>
						  </div>
						  <div class="mb-3" id="confirm-body">
						  	<label class="form-label">确认按钮跳转参数</label>
						  	<input class="form-control"/>
						  </div>
						  <div class="mb-3" id="confirm-type">
						  	<label class="form-label">确认按钮跳转效果</label>
						  	<select class="form-select">
								<option>无</option>
						  		<option>增页跳转</option>
						  		<option>替换跳转</option>
								<option>重载跳转</option>
						  	</select>
						  </div>
						  <div class="mb-3" id="cancel-title" style="display:none;">
						  	<label class="form-label">取消按钮文字</label>
						  	<input class="form-control"/>
						  </div>
						  <div class="mb-3" id="cancel-body" style="display:none;">
						  	<label class="form-label">取消按钮跳转参数</label>
						  	<input class="form-control"/>
						  </div>
						  <div class="mb-3" id="cancel-type" style="display:none;">
						  	<label class="form-label">取消按钮跳转效果</label>
						  	<select class="form-select">
								<option>无</option>
						  		<option>增页跳转</option>
						  		<option>替换跳转</option>
						  		<option>重载跳转</option>
						  	</select>
						  </div>
					  </div>
						<div class="modal-footer">
					        <button type="button" class="btn btn-primary">保存</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		<script src="https://cdn.bootcdn.net/ajax/libs/jquery/3.6.4/jquery.min.js"></script>
		<script src="https://cdn.bootcdn.net/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js"></script>
		<script src="https://cdn.bootcdn.net/ajax/libs/jquery-confirm/3.3.4/jquery-confirm.min.js"></script>
		<script src="https://cdn.bootcdn.net/ajax/libs/twitter-bootstrap/5.2.3/js/bootstrap.min.js"></script>
		<script src="../../js/default.js"></script>
		<script>
			var page=1;
			var search_user='';
			$(function(){
				if(getvalue('id')){
					$("input[name='user']").val(getvalue('id'))
					$('button:first').click();
				}
			})
			$('button:first').click(function(){
				search($("input[name='user']").val(),1)
			})
			$('.btn-success').click(function(){
				$('#add').modal('show');
				$('#user').val($("input[name='user']").val())
			})
			$('#type').change(function(){
				if($('#type').val()=="弹窗"){
					$('#push-type').hide()
					$('#push-body').hide()
					$('#push-title').hide()
					$('#push-detail').hide()
					$('#push-body-type').hide()
					$('#title').show()
					$('#body').show()
					$('#alert-type').show()
					$('#confirm-title').show()
					$('#confirm-type').show()
					$('#confirm-body').show()
					$('#alert-type input').prop("checked",false)
					$('#cancel-title').hide()
					$('#cancel-type').hide()
					$('#cancel-body').hide()
				}else if($('#type').val()=="通知栏"){
					$('#push-type').show()
					$('#push-type select').val("弹窗")
					$('#push-title').show()
					$('#push-detail').show()
					$('#push-body').hide()
					$('#push-body-type').hide()
					$('#title').show()
					$('#body').show()
					$('#alert-type').show()
					$('#confirm-title').show()
					$('#confirm-type').show()
					$('#confirm-body').show()
					$('#alert-type input').prop("checked",false)
					$('#cancel-title').hide()
					$('#cancel-type').hide()
					$('#cancel-body').hide()
				}else{
					$('#push-type').hide()
					$('#title').hide()
					$('#body').hide()
					$('#push-body').show()
					$('#push-title').hide()
					$('#push-detail').hide()
					$('#push-body-type').show()
					$('#alert-type').hide()
					$('#confirm-title').hide()
					$('#confirm-type').hide()
					$('#confirm-body').hide()
					$('#cancel-title').hide()
					$('#cancel-type').hide()
					$('#cancel-body').hide()
				}
			})
			$('#alert-type input').change(function(){
				if($('#alert-type input').prop("checked")){
					$('#cancel-title').show()
					$('#cancel-type').show()
					$('#cancel-body').show()
				}else{
					$('#cancel-title').hide()
					$('#cancel-type').hide()
					$('#cancel-body').hide()
				}
			})
			$('#push-type select').change(function(){
				if($('#push-type select').val()=="弹窗"){
					$('#push-body').hide()
					$('#push-body-type').hide()
					$('#push-title').show()
					$('#push-detail').show()
					$('#alert-type').show()
					$('#confirm-title').show()
					$('#confirm-type').show()
					$('#confirm-body').show()
					$('#alert-type input').prop("checked",false)
					$('#cancel-title').hide()
					$('#cancel-type').hide()
					$('#cancel-body').hide()
				}else if($('#push-type select').val()=="Url"){
					$('#push-body').show()
					$('#push-body-type').show()
					$('#push-title').hide()
					$('#push-detail').hide()
					$('#alert-type').hide()
					$('#confirm-title').hide()
					$('#confirm-type').hide()
					$('#confirm-body').hide()
					$('#cancel-title').hide()
					$('#cancel-type').hide()
					$('#cancel-body').hide()
				}else{
					$('#push-body').hide()
					$('#push-body-type').hide()
					$('#push-title').hide()
					$('#push-detail').hide()
					$('#alert-type').hide()
					$('#confirm-title').hide()
					$('#confirm-type').hide()
					$('#confirm-body').hide()
					$('#cancel-title').hide()
					$('#cancel-type').hide()
					$('#cancel-body').hide()
				}
			})
			$('li[name="上一页"] a').click(function(){
				search(search_user,page-1)
			})
			$('li[name="下一页"] a').click(function(){
				search(search_user,page+1)
			})
			$('input[name="page"]').keypress(function (event) {
				if (event.keyCode === 13) {
					search(search_id,$("input[name='page']").val())
				}
			});
			function search(user,p){
				console.log(page)
				sftools.api({
					url:"GetUserNoticeList",
					data:{"user":user,"page":p},
				},function(e){
					$('tbody').html('')
					search_user=user;
					page=e.page
					$('li[name="page"]').html(e.count+'条记录 共 '+e.pages+' 页')
					$('input[name="page"]').val(e.page)
					if(e.page>1){
						$('li[name="上一页"]').removeClass('disabled')
					}else{
						$('li[name="上一页"]').addClass('disabled')
					}
					if(e.page>=e.pages){
						$('li[name="下一页"]').addClass('disabled')
					}else{
						$('li[name="下一页"]').removeClass('disabled')
					}
					let html=''
					for(var n=0;n<e.data.length;n++){
						html=html+'<tr><td>'+e.data[n].id+'</td>'
						html=html+'<td>'+e.data[n].user+'</td>'
						html=html+'<td>'+e.data[n].appid+'</td>'
						let type='通知栏消息'
						if(e.data[n].type==1)type='消息弹窗';
						else if(e.data[n].type==2)type='消息弹窗 - 跳转网页';
						else if(e.data[n].type==3)type='确认弹窗 - 跳转网页';
						else if(e.data[n].type==4)type='跳转网页';
						html=html+'<td>'+type+'</td>'
						html=html+'<td>'+e.data[n].title+'</td>'
						html=html+'<td>'+e.data[n].detail+'</td>'
						let status='<span class="badge bg-primary">未读</span>'
						if(e.data[n].status==1){
							status='<span class="badge bg-success">已读</span>'
						}
						html=html+'<td>'+status+'</td><td><div class="btn-group btn-group-sm"><a class="btn btn-primary" href="#!"><i class="mdi mdi-pencil"></i><span class="d-none d-sm-inline"> 操作</span></a></div></td></tr>'
					}
					$('tbody').html(html)
				},
				function(){});
			}
			$('table').on("click","a",function(){
				let id=$(this).parent().parent().siblings('td:first').html();
				sftools.api({
					url:"GetUserNoticeDetail",
					data:id
				},function(e){
					$('#detail').modal('show');
					$('#detail .modal-body').html('')
					html='<p>记录ID：'+e.id+'</p>'
					html=html+'<p>用户ID：'+e.user+'</p>'
					html=html+'<p>操作应用：'+e.appid+'</p>'
					let type='通知栏消息'
					if(e.type==1)type='消息弹窗';
					else if(e.type==2)type='消息弹窗 - 跳转网页';
					else if(e.type==3)type='确认弹窗 - 跳转网页';
					else if(e.type==4)type='跳转网页';
					html=html+'<p>弹窗类型：'+type+'</p>'
					html=html+'<p>弹窗标题：'+e.title+'</p>'
					html=html+'<p>弹窗内容：'+e.detail+'</p>'
					html=html+'<p>弹窗数据：</p><p>'+e.data+'</p>'
					html=html+'<p>创建时间：'+timetostring(e.create_time)+'</p>'
					html=html+'<p>创建IP：'+e.create_ip+'</p>'
					let status='<span class="badge bg-primary">未读</span>'
					if(e.status==1){
						html=html+'<p>接收时间：'+timetostring(e.last_time)+'</p>'
						html=html+'<p>接收IP：'+e.last_ip+'</p>'
						status='<span class="badge bg-success">已读</span>'
					}
					html=html+'<p>当前状态：'+status+'</p>'
					$('#detail .modal-body').html(html)
				},
				function(){});
			});
			$('#add .btn-primary').click(function(){
				let data={"title":$('#title input').val(),"body":$('#body input').val()}
				if($('#type').val()=="弹窗"){
					data.type="alert"
					data.data={
						"confirm":$('#alert-type input').prop("checked"),
						"confirm_text":$('#confirm-title input').val()
					}
					data.data.confirm_url={}
					if($('#confirm-type select').val()!=="无"){
						data.data.confirm_url.data=$('#confirm-body input').val()
					}else{
						data.data.confirm_url=null
					}
					if($('#confirm-type select').val()=="增页跳转"){
						data.data.confirm_url.type=1
					}else if($('#confirm-type select').val()=="替换跳转"){
						data.data.confirm_url.type=2
					}else if($('#confirm-type select').val()=="重载跳转"){
						data.data.confirm_url.type=3
					}
					if($('#alert-type input').prop("checked")){
						data.data.cancel_text=$('#cancel-title input').val()
						data.data.cancel_url={}
						if($('#cancel-type select').val()!=="无"){
							data.data.cancel_url.data=$('#cancel-body input').val()
						}else{
							data.data.cancel_url=null
						}
						if($('#cancel-type select').val()=="增页跳转"){
							data.data.cancel_url.type=1
						}else if($('#cancel-type select').val()=="替换跳转"){
							data.data.cancel_url.type=2
						}else if($('#cancel-type select').val()=="重载跳转"){
							data.data.cancel_url.type=3
						}
					}
				}else if($('#type').val()=="通知栏"){
					data.type="push"
					data.data={}
					if($('#push-type select').val()=="弹窗"){
						data.data.type="alert"
						data.title=$('#push-title input').val()
						data.body=$('#push-detail input').val()
						data.data.title=$('#title input').val()
						data.data.detail=$('#body input').val()
						data.data.data={
							"confirm":$('#alert-type input').prop("checked"),
							"confirm_text":$('#confirm-title input').val()
						}
						data.data.data.confirm_url={}
						if($('#confirm-type select').val()!=="无"){
							data.data.data.confirm_url.data=$('#confirm-body input').val()
						}else{
							data.data.data.confirm_url=null
						}
						if($('#confirm-type select').val()=="增页跳转"){
							data.data.data.confirm_url.type=1
						}else if($('#confirm-type select').val()=="替换跳转"){
							data.data.data.confirm_url.type=2
						}else if($('#confirm-type select').val()=="重载跳转"){
							data.data.data.confirm_url.type=3
						}
						if($('#alert-type input').prop("checked")){
							data.data.data.cancel_text=$('#cancel-title input').val()
							data.data.data.cancel_url={}
							if($('#cancel-type select').val()!=="无"){
								data.data.data.cancel_url.data=$('#cancel-body input').val()
							}else{
								data.data.data.cancel_url=null
							}
							if($('#cancel-type select').val()=="增页跳转"){
								data.data.data.cancel_url.type=1
							}else if($('#cancel-type select').val()=="替换跳转"){
								data.data.data.cancel_url.type=2
							}else if($('#cancel-type select').val()=="重载跳转"){
								data.data.data.cancel_url.type=3
							}
						}
					}else if($('#push-type select').val()=="Url"){
						data.data.type="url"
						data.data.data=$('#push-body input').val()
						if($('#push-body-type select').val()=="增页跳转"){
							data.data.way=1
						}else if($('#push-body-type select').val()=="替换跳转"){
							data.data.way=2
						}else if($('#push-body-type select').val()=="重载跳转"){
							data.data.way=3
						}
					}else{
						data.data.type=null
					}
				}else{
					data={
						"title":"",
						"body":"",
						"type":"url",
						"data":{
							"data":$('#push-body input').val()
						}
					}
					if($('#push-body-type select').val()=="增页跳转"){
						data.data.type=1
					}else if($('#push-body-type select').val()=="替换跳转"){
						data.data.type=2
					}else if($('#push-body-type select').val()=="重载跳转"){
						data.data.type=3
					}
				}
				console.log(data)
				data.user=$('#user').val()
				sftools.api({
					url:"AddUserNotice",
					data:data
				},function(e){
					$.alert({type:'green',icon:"mdi mdi-check-bold",title:'操作成功',content:''});
					search($("input[name='user']").val(),1)
				},function(){});
			})
		</script>
	</body>
</html>